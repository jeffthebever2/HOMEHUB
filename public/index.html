<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ  Home Hub</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>

  <!-- App config (must come before app scripts) -->
  <script src="config.js"></script>

  <style>
    :root { --bg: #111827; --card: #1f2937; --card-hover: #374151; --accent: #3b82f6; }
    body { background: var(--bg); color: #f9fafb; font-family: system-ui, -apple-system, sans-serif; margin: 0; }
    .card { background: var(--card); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,.3); }
    .btn { padding: .5rem 1rem; border-radius: .5rem; font-weight: 500; cursor: pointer; transition: all .2s; border: none; display: inline-flex; align-items: center; gap: .4rem; }
    .btn-primary { background: #3b82f6; color: #fff; } .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: #374151; color: #fff; } .btn-secondary:hover { background: #4b5563; }
    .btn-danger { background: #ef4444; color: #fff; } .btn-danger:hover { background: #dc2626; }
    .btn-success { background: #10b981; color: #fff; } .btn-success:hover { background: #059669; }
    .input { background: #374151; border: 1px solid #4b5563; border-radius: .5rem; padding: .5rem 1rem; color: #fff; width: 100%; box-sizing: border-box; }
    .input:focus { outline: none; border-color: #3b82f6; }
    .hidden { display: none !important; }
    .page { display: none; } .page.active { display: block; }
    .standby-clock { font-variant-numeric: tabular-nums; letter-spacing: -.05em; }
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .photo-item { aspect-ratio: 16/9; background: #1f2937; border-radius: .5rem; overflow: hidden; }
    .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: opacity 1s; }
    .alert-banner { position: fixed; top: 0; left: 0; right: 0; z-index: 50; padding: .75rem 1rem; text-align: center; font-weight: 700; }
    .alert-banner.warning { background: #ef4444; } .alert-banner.watch { background: #f59e0b; color: #000; } .alert-banner.advisory { background: #eab308; color: #000; }
    .status-dot { display: inline-block; width: .75rem; height: .75rem; border-radius: 50%; }
    .status-dot.green { background: #10b981; } .status-dot.red { background: #ef4444; } .status-dot.yellow { background: #f59e0b; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; z-index: 60; padding: 1rem; }
    .progress-bar { height: 1rem; background: #374151; border-radius: 9999px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 9999px; transition: width .4s; }
    select.input { appearance: auto; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-4"></div>
        <p class="text-xl text-gray-400" id="loadingText">Loading Home Hubâ€¦</p>
      </div>
    </div>
    <script>
      // Instant check: does localStorage have a saved Supabase session?
      try {
        const key = Object.keys(localStorage).find(k => k.startsWith('sb-') && k.endsWith('-auth-token'));
        if (key) {
          const stored = JSON.parse(localStorage.getItem(key));
          const email = stored?.user?.email;
          const el = document.getElementById('loadingText');
          if (email && el) el.textContent = 'Welcome back, ' + email.split('@')[0] + '! Signing inâ€¦';
        }
      } catch (e) { /* ignore */ }
    </script>

    <!-- Login Screen -->
    <div id="loginScreen" class="page min-h-screen flex items-center justify-center">
      <div class="card max-w-md w-full text-center mx-4">
        <h1 class="text-5xl font-bold mb-4">ğŸ  Home Hub</h1>
        <p class="text-gray-400 mb-8">Your family command center</p>
        <button id="btnGoogleLogin" class="btn btn-primary w-full text-lg py-3">Sign in with Google</button>
        <button id="btnCheckSupabase" class="btn btn-secondary w-full text-sm py-2 mt-4">ğŸ” Check Supabase</button>
        <pre id="debugOutput" style="display:none; text-align:left; font-size:0.7rem; line-height:1.4; background:#0f172a; color:#94a3b8; padding:1rem; border-radius:0.5rem; margin-top:1rem; max-height:400px; overflow:auto; white-space:pre-wrap; word-break:break-all;"></pre>
      </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="page min-h-screen flex items-center justify-center">
      <div class="card max-w-md w-full text-center mx-4">
        <div class="text-7xl mb-6">ğŸš«</div>
        <h1 class="text-4xl font-bold mb-4">Access Denied</h1>
        <p class="text-gray-400 mb-4">Your account is not authorized.</p>
        <p class="text-gray-500 text-sm mb-8" id="deniedEmail"></p>
        <button id="btnSignOutDenied" class="btn btn-secondary w-full">Sign Out</button>
      </div>
    </div>

    <!-- Alert Banner (fixed top) -->
    <div id="alertBanner" class="alert-banner hidden"></div>

    <!-- Alert Popup Modal -->
    <div id="alertPopup" class="modal-overlay hidden">
      <div class="card max-w-2xl w-full text-center">
        <div class="text-7xl mb-4">âš ï¸</div>
        <h2 class="text-3xl font-bold mb-4">Weather Alert</h2>
        <p id="alertPopupText" class="text-xl mb-6"></p>
        <button id="btnDismissAlert" class="btn btn-primary px-8 py-3">Acknowledged</button>
      </div>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <div id="dashboardPage" class="page">
      <div class="max-w-7xl mx-auto p-4 md:p-6">
        <header class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-4xl md:text-5xl font-bold">ğŸ  Home Hub</h1>
            <p class="text-gray-400 mt-1" id="dashboardDate"></p>
            <p class="text-blue-400 text-sm mt-1" id="dashboardGreeting"></p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button onclick="Hub.router.go('standby')" class="btn btn-secondary">ğŸ–¥ Standby</button>
            <button onclick="Hub.router.go('status')" class="btn btn-secondary">ğŸ“Š Status</button>
            <button onclick="Hub.router.go('settings')" class="btn btn-secondary">âš™ï¸ Settings</button>
            <button id="btnSignOut" class="btn btn-secondary">Sign Out</button>
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Weather Card -->
          <div class="card lg:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold">ğŸŒ¤ï¸ Weather</h2>
              <button onclick="Hub.router.go('weather')" class="text-blue-400 hover:text-blue-300 text-sm">Full Forecast â†’</button>
            </div>
            <div id="dashboardWeather"><p class="text-gray-400">Loading weatherâ€¦</p></div>
          </div>

          <!-- Quick Links -->
          <div class="card">
            <h2 class="text-2xl font-bold mb-4">Quick Access</h2>
            <div class="space-y-3">
              <div onclick="Hub.router.go('weather')" class="bg-gray-800 hover:bg-gray-700 rounded-lg p-4 cursor-pointer transition">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸŒ¤ï¸</span><div><p class="font-medium">Weather Center</p><p class="text-sm text-gray-400">Detailed forecast</p></div></div>
              </div>
              <div onclick="Hub.router.go('chores')" class="bg-gray-800 hover:bg-gray-700 rounded-lg p-4 cursor-pointer transition">
                <div class="flex items-center gap-3"><span class="text-3xl">âœ…</span><div><p class="font-medium">Chores</p><p class="text-sm text-gray-400">Manage tasks</p></div></div>
              </div>
              <div onclick="Hub.router.go('treats')" class="bg-gray-800 hover:bg-gray-700 rounded-lg p-4 cursor-pointer transition">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸ•</span><div><p class="font-medium">Dog Treats</p><p class="text-sm text-gray-400">Track calories</p></div></div>
              </div>
            </div>
          </div>

          <!-- Chores Preview -->
          <div class="card">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold">Today's Chores</h2>
              <button onclick="Hub.router.go('chores')" class="text-blue-400 hover:text-blue-300 text-sm">View All</button>
            </div>
            <div id="dashboardChores"><p class="text-gray-400 text-sm">No pending chores</p></div>
          </div>

          <!-- Calendar Widget -->
          <div class="card lg:col-span-2">
            <h2 class="text-2xl font-bold mb-4">ğŸ“… Calendar</h2>
            <div id="calendarWidget" class="bg-gray-800 rounded-lg p-6 text-center">
              <p class="text-gray-400">Calendar integration â€” set a Google Calendar URL in Settings</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== STANDBY ========== -->
    <div id="standbyPage" class="page min-h-screen bg-black text-white relative cursor-pointer">
      <div id="standbyPhotos" class="absolute inset-0 opacity-30"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
      <div class="relative z-10 flex flex-col justify-between min-h-screen p-8" id="standbyContent">
        <div class="text-center">
          <div id="standbyClock" class="standby-clock text-8xl md:text-9xl font-bold tracking-tight"></div>
          <div id="standbyDate" class="text-2xl md:text-3xl text-gray-400 mt-4"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="bg-black/50 backdrop-blur rounded-xl p-6">
            <h3 class="text-xl font-bold mb-3">Weather</h3>
            <div id="standbyWeather"><p class="text-gray-400 text-sm">Loadingâ€¦</p></div>
          </div>
          <div class="bg-black/50 backdrop-blur rounded-xl p-6">
            <h3 class="text-xl font-bold mb-3">Upcoming</h3>
            <div id="standbyCalendar"><p class="text-gray-400 text-sm">No events scheduled</p></div>
          </div>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-gray-600 text-sm z-10">Touch anywhere to wake</div>
    </div>

    <!-- ========== WEATHER ========== -->
    <div id="weatherPage" class="page">
      <div class="max-w-7xl mx-auto p-4 md:p-6">
        <header class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">ğŸŒ¤ï¸ Weather Center</h1>
          <button onclick="Hub.router.go('dashboard')" class="btn btn-secondary">â† Back</button>
        </header>
        <div id="weatherContent"><p class="text-gray-400">Loading detailed weatherâ€¦</p></div>
        <div class="card mt-6">
          <h2 class="text-xl font-bold mb-4">ğŸŒ§ Rain Radar</h2>
          <div id="rainRadar" class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">Loading radarâ€¦</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== CHORES ========== -->
    <div id="choresPage" class="page">
      <div class="max-w-7xl mx-auto p-4 md:p-6">
        <header class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">âœ… Chores</h1>
          <div class="flex gap-3">
            <button id="btnAddChore" class="btn btn-primary">+ Add Chore</button>
            <button onclick="Hub.router.go('dashboard')" class="btn btn-secondary">â† Back</button>
          </div>
        </header>
        <div id="choresList"></div>
      </div>
    </div>

    <!-- ========== TREATS ========== -->
    <div id="treatsPage" class="page">
      <div class="max-w-7xl mx-auto p-4 md:p-6">
        <header class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">ğŸ• Dog Treats</h1>
          <button onclick="Hub.router.go('dashboard')" class="btn btn-secondary">â† Back</button>
        </header>
        <div id="dogSelector" class="mb-6"></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="card md:col-span-2">
            <h2 class="text-2xl font-bold mb-4" id="selectedDogName">Select a dog</h2>
            <div id="calorieProgress" class="mb-6"></div>
            <div id="todayTreats"></div>
            <div id="weekHistory" class="mt-6"></div>
          </div>
          <div class="card">
            <button id="btnAddTreat" class="btn btn-primary w-full mb-4">+ Log Treat</button>
            <button id="btnAddDog" class="btn btn-secondary w-full">+ Add Dog</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== STATUS ========== -->
    <div id="statusPage" class="page">
      <div class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">ğŸ“Š System Status</h1>
          <div class="flex gap-3">
            <button id="btnRefreshStatus" class="btn btn-primary">Refresh</button>
            <button onclick="Hub.router.go('dashboard')" class="btn btn-secondary">â† Back</button>
          </div>
        </header>
        <div id="statusContent"><p class="text-gray-400">Checking servicesâ€¦</p></div>
      </div>
    </div>

    <!-- ========== SETTINGS ========== -->
    <div id="settingsPage" class="page">
      <div class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">âš™ï¸ Settings</h1>
          <button onclick="Hub.router.go('dashboard')" class="btn btn-secondary">â† Back</button>
        </header>
        <div class="space-y-6">
          <!-- Location -->
          <div class="card">
            <h2 class="text-xl font-bold mb-4">ğŸ“ Location</h2>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-2">Location Name</label><input id="settingLocationName" type="text" class="input" placeholder="Home"></div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium mb-2">Latitude</label><input id="settingLat" type="number" step="0.000001" class="input"></div>
                <div><label class="block text-sm font-medium mb-2">Longitude</label><input id="settingLon" type="number" step="0.000001" class="input"></div>
              </div>
              <button id="btnUseLocation" class="btn btn-secondary text-sm">ğŸ“ Use Current Location</button>
            </div>
          </div>
          <!-- Immich -->
          <div class="card">
            <h2 class="text-xl font-bold mb-4">ğŸ“¸ Immich Photos</h2>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-2">Immich Base URL</label><input id="settingImmichUrl" type="url" class="input" placeholder="http://192.168.1.100:2283"></div>
              <div><label class="block text-sm font-medium mb-2">API Key / Shared Token</label><input id="settingImmichKey" type="password" class="input" placeholder="Your Immich API key or shared link key"></div>
              <div><label class="block text-sm font-medium mb-2">Album ID</label><input id="settingImmichAlbum" type="text" class="input" placeholder="Shared album ID"></div>
            </div>
          </div>
          <!-- Standby -->
          <div class="card">
            <h2 class="text-xl font-bold mb-4">ğŸ’¤ Standby Mode</h2>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-2">Auto-enter after (minutes)</label><input id="settingIdleTimeout" type="number" class="input" value="10" min="1" max="60"></div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium mb-2">Quiet Hours Start</label><input id="settingQuietStart" type="time" class="input" value="22:00"></div>
                <div><label class="block text-sm font-medium mb-2">Quiet Hours End</label><input id="settingQuietEnd" type="time" class="input" value="07:00"></div>
              </div>
            </div>
          </div>
          <!-- Calendar -->
          <div class="card">
            <h2 class="text-xl font-bold mb-4">ğŸ“… Calendar</h2>
            <div><label class="block text-sm font-medium mb-2">Google Calendar Embed URL</label><input id="settingCalendarUrl" type="url" class="input" placeholder="https://calendar.google.com/calendar/embed?src=..."></div>
          </div>
          <button id="btnSaveSettings" class="btn btn-primary w-full py-3">Save All Settings</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MODALS ========== -->
  <div id="addDogModal" class="modal-overlay hidden">
    <div class="card max-w-lg w-full">
      <h2 class="text-2xl font-bold mb-4">Add Dog</h2>
      <div class="space-y-4">
        <input id="dogName" type="text" placeholder="Name" class="input">
        <input id="dogCalories" type="number" placeholder="Daily calorie limit" class="input" value="1000">
        <div class="flex gap-3">
          <button id="btnSaveDog" class="btn btn-primary flex-1">Add Dog</button>
          <button onclick="Hub.ui.closeModal('addDogModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="addTreatModal" class="modal-overlay hidden">
    <div class="card max-w-lg w-full">
      <h2 class="text-2xl font-bold mb-4">Log Treat</h2>
      <div class="space-y-4">
        <input id="treatName" type="text" placeholder="Treat name" class="input">
        <input id="treatCalories" type="number" placeholder="Calories" class="input">
        <div class="flex gap-3">
          <button id="btnSaveTreat" class="btn btn-primary flex-1">Log Treat</button>
          <button onclick="Hub.ui.closeModal('addTreatModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="addChoreModal" class="modal-overlay hidden">
    <div class="card max-w-lg w-full">
      <h2 class="text-2xl font-bold mb-4">Add Chore</h2>
      <div class="space-y-4">
        <input id="choreTitle" type="text" placeholder="Title" class="input">
        <textarea id="choreDescription" placeholder="Description (optional)" class="input" rows="3"></textarea>
        <select id="chorePriority" class="input">
          <option value="low">Low Priority</option>
          <option value="medium" selected>Medium Priority</option>
          <option value="high">High Priority</option>
        </select>
        <div class="flex gap-3">
          <button id="btnSaveChore" class="btn btn-primary flex-1">Create Chore</button>
          <button onclick="Hub.ui.closeModal('addChoreModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts (order matters) -->
  <script src="assets/utils.js"></script>
  <script src="assets/supabase.js"></script>
  <script src="assets/router.js"></script>
  <script src="assets/ui.js"></script>
  <script src="assets/weather.js"></script>
  <script src="assets/ai.js"></script>
  <script src="assets/calendar.js"></script>
  <script src="assets/treats.js"></script>
  <script src="assets/chores.js"></script>
  <script src="assets/standby.js"></script>
  <script src="assets/immich.js"></script>
  <script src="assets/app.js"></script>
</body>
</html>
